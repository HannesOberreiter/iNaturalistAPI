<html>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
  <style>
    #map, html, body {
      width: 100%; height: 100%; padding: 0; margin: 0;
      cursor: pointer;
    }
    .legend {
      position: absolute;
      bottom: 25;
      z-index: 1000;
      width: 100%;
    }
    #date {
      text-align: center;
      background: rgba(255,255,255,0.2);
      width: 200;
      z-index: 1000;
      margin-left: auto;
      margin-right: auto;
      line-height: 40px;
      font-size: 20px;
      color: white;
      font-family: "system-ui";
    }
  </style>
  <body>
    <div id="map"></div>

    <div class="legend">
      <div id="prev"/>
      <div id="date"/>
      <div id="next"/>
    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.2/moment.min.js"></script>
    <script>
      /* global $, moment */
      var torqueLayer;
      var currentStep;
      var requestAnimationFrame = function( callback ) {
        if ( torqueLayer ) {
          var thisStep = torqueLayer.getStep( );
          if ( thisStep != currentStep ) {
            currentStep = thisStep;
            console.log( [ "On step:" ], currentStep );
            $( "#date" ).html( moment.months( currentStep ) );
            // $( "#date" ).html( moment().day("Monday").week(currentStep) .format("MMM DD"));
          }
        }
        setTimeout(callback, 1000 / 60);
      }

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
    <script src="./torque.full.uncompressed.js"></script>


    <script>
      /* global L, window, $, document */
      // define the torque layer style using cartocss
      var url = new URL(window.location.href);
      var color = url.searchParams.get("color") || "#feb891";
      color = "green";
      var CARTOCSS = [
        "Map { }",
        "#layer {",
          "marker-width: 4; ",
          "marker-fill: " + color + ";",
          "marker-fill-opacity: 0.4;",
          "[value > 2] { marker-width: 6; }",
          "[value > 4] { marker-width: 8; }",
          "[value > 6] { marker-width: 10; }",
          "[lifeStage = 'Adult'] { marker-fill:blue; }",
          "[lifeStage = 'Pupa'] { marker-fill:green; }",
          "[lifeStage = 'Larva'] { marker-fill:orange; }",
          "[lifeStage = 'Flowering'] { marker-fill:orange; }",
          "[lifeStage = 'Fruiting'] { marker-fill:red; }",
          "[lifeStage = 'Budding'] { marker-fill:green; }",
          // "marker-fill: #585858; ['taxon.iconic_taxon_id'=1] { marker-fill: #1E90FF; } ['taxon.iconic_taxon_id'=3] { marker-fill: #1E90FF; } ['taxon.iconic_taxon_id'=20978] { marker-fill: #1E90FF; } ['taxon.iconic_taxon_id'=26036] { marker-fill: #1E90FF; } ['taxon.iconic_taxon_id'=40151] { marker-fill: #1E90FF; } ['taxon.iconic_taxon_id'=47115] { marker-fill: #FF4500; } ['taxon.iconic_taxon_id'=47119] { marker-fill: #FF4500; } ['taxon.iconic_taxon_id'=47126] { marker-fill: #73AC13; } ['taxon.iconic_taxon_id'=47158] { marker-fill: #FF4500; } ['taxon.iconic_taxon_id'=47170] { marker-fill: #FF1493; } ['taxon.iconic_taxon_id'=47178] { marker-fill: #1E90FF; } ['taxon.iconic_taxon_id'=47686] { marker-fill: #691776; } ['taxon.iconic_taxon_id'=48222] { marker-fill: #993300; }",
          "[frame-offset = 1] {",
            "marker-width: 3;",
            "marker-fill-opacity: 0.2;",
          "}",
          "[frame-offset = 2] { ",
            "marker-width: 2;",
            "marker-fill-opacity: 0.1;",
          "}",
        "}"
      ].join( "\n" );

        
      var map = new L.Map("map", {
        zoomControl: true,
        center: [
          url.searchParams.get( "lat" ) || 20,
          url.searchParams.get( "lng" ) || 10
        ],
        zoom: url.searchParams.get( "zoom" ) || 2,
        keyboard: false
      });

      L.tileLayer( "https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png", {
        attribution: "CartoDB"
      }).addTo( map ).on( "done", function( layer ) {
        console( layer );
      });

      var searchUrl = new URL(window.location.href);
      searchUrl.searchParams.delete("zoom");
      url.searchParams.delete("lat");
      url.searchParams.delete("lng");

      var torqueLayer = new L.TorqueLayer({
        tileJSON: "v1/tiles.json?" + window.location.search.substr( 1 ),
        cartocss: CARTOCSS,
        blendmode: url.searchParams.get( "blendmode" ) || "overlay",
        animationDuration: 6,
        zIndex: 10,
        time_slider: true,
        map: map
      });
      torqueLayer.error( function( err ) {
        for( var error in err ) {
          console.warn( err[error] );
        }
      });
      torqueLayer.addTo( map );
      torqueLayer.play( );
      // torqueLayer.renderRange(0, 11);
      $("#date").on("click", function( ) {
        torqueLayer.toggle( );
      } );
      document.addEventListener( "keydown", function( event ) {
        var currentStep = torqueLayer.getStep( );
        var nextKey;
        if( event.keyCode == 32) {
          torqueLayer.toggle( );
        } else if( event.keyCode == 37) {
          if ( torqueLayer.isRunning( ) ) { torqueLayer.stop( ); }
          nextKey = currentStep - 1;
          if ( nextKey < 0 ) {
            nextKey = torqueLayer.provider.options.data_steps - 1;
          }
          torqueLayer.setStep( nextKey );
        } else if( event.keyCode == 39 ) {
          if ( torqueLayer.isRunning( ) ) { torqueLayer.stop( ); }
          nextKey = currentStep + 1;
          if ( nextKey >= torqueLayer.provider.options.data_steps ) {
            nextKey = 0;
          }
          torqueLayer.setStep( nextKey );
        }
      });

      map.on('click', function(e) {
        var p = e.containerPoint;
        console.log(p);
        var value = torqueLayer.getValueForPos(p.x, p.y);
        console.log(value);
        if (value !== null) {
          map.openPopup("ObservationID: " + value.value.id, e.latlng);
        }
      });


      function checkMapPosition( ) {
        var center = map.getCenter( );
        var zoom = map.getZoom( );
        var url = new URL(window.location.href);
        url.searchParams.set( "zoom", zoom );
        url.searchParams.set( "lat", center.lat );
        url.searchParams.set( "lng", center.lng );
        window.history.replaceState( null, null, url.href );
        setTimeout( checkMapPosition, 1000 );
      }
      checkMapPosition( );

    </script>
  </body>
</html>


